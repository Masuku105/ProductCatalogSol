@model ProductCatalogWeb.Models.ProductListViewModel
@{
    ViewData["Title"] = "Products";
}
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" />

</head>
<div class="input-group mb-3">
    <h2>DreamTeam Assement Xolani Masuku</h2>
 </div>
<div class="input-group mb-3">   
    <input id="searchInput" class="form-control" placeholder="Search products..." aria-label="Search" aria-describedby="search-icon" />
    <span class="input-group-text" id="search-icon">
        <i class="fas fa-search"></i>
    </span>
</div>

<div class="mb-3">
    <button type="button" class="btn btn-success create-btn">Create New Product</button>
</div>

<div id="modalPlaceholder"></div>

<div id="productsContainer" class="row">
    @foreach (var p in Model.Products)
    {
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <img src="@p.Image" class="card-img-top" style="height:200px; object-fit:contain" alt="@p.Title" />
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">@p.Title</h5>
                    <p class="card-text">@p.Description</p>
                    <p><strong>Price:</strong> $@p.Price</p>
                    <div class="mt-auto">
                        <button class="btn btn-warning edit-btn" data-id="@p.Id">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<nav>
    <ul class="pagination justify-content-center" id="paginationContainer">
        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                <a href="javascript:void(0)" class="page-link" onclick="goToPage(@i)">@i</a>
            </li>
        }        
    </ul>
</nav>

@section Scripts {

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validate/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/lib/jquery-unobtrusive-ajax/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPage = @Model.CurrentPage;
        let totalPages = @Model.TotalPages;

        async function loadData(search = '', page = 1) {
            const resp = await fetch(`/Product/GetProductsJson?search=${encodeURIComponent(search)}&page=${page}`);
            const data = await resp.json();
            renderProducts(data.products);
            renderPagination(data.currentPage, data.totalPages);
        }

        function renderProducts(products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            if (!products?.length) {
                container.innerHTML = '<p>No products found.</p>';
                return;
            }
            products.forEach(p => {
                container.innerHTML += `
                    <div class="col-md-4 mb-4">
                      <div class="card h-100">
                        <img src="${p.image}" class="card-img-top" style="height:200px; object-fit:contain" alt="${p.title}" />
                        <div class="card-body d-flex flex-column">
                          <h5 class="card-title">${p.title}</h5>
                          <p class="card-text">${p.description}</p>
                          <p><strong>Price:</strong> $${p.price}</p>
                          <div class="mt-auto">
                            <button class="btn btn-warning edit-btn" data-id="${p.id}">Edit</button>
                          </div>
                        </div>
                      </div>
                    </div>`;
            });
        }

        function renderPagination(page, total) {
            currentPage = page;
            totalPages = total;
            const nav = document.getElementById('paginationContainer');
            nav.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                nav.innerHTML += `
                    <li class="page-item ${i === page ? 'active' : ''}">
                      <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                    </li>`;
            }
        }

        function goToPage(page) {
            const search = document.getElementById('searchInput').value;
            loadData(search, page);
        }

        document.getElementById('searchInput').addEventListener('input', e => loadData(e.target.value, 1));

        // Open Create modal
        $('body').on('click', '.create-btn', function() {
            $.get('/Product/GetCreateModal', html => {
                $('#modalPlaceholder').html(html);
                $('#productModal').modal('show');
            });
        });

        // Open Edit modal
        $('body').on('click', '.edit-btn', function() {
            $.get(`/Product/GetEditModal?id=${this.dataset.id}`, html => {
                $('#modalPlaceholder').html(html);
                $('#productModal').modal('show');
            });
        });

        // Handle AJAX form submission using unobtrusive AJAX
        $('body').on('ajax:success', 'form[data-ajax="true"]', function() {
            $('#productModal').modal('hide');
            loadData($('#searchInput').val(), currentPage);
        });

        // Handle validation errors (modal still shown)
        $('body').on('ajax:error', 'form[data-ajax="true"]', function(event) {
            const response = event.detail[2]?.response;
            $('#productModal .modal-content').html(response);
            $('#productModal').modal('show');
        });
    </script>
}
